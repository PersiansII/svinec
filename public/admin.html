<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <!-- include shared calendar styles -->
  <link rel="stylesheet" href="/styles.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
      margin-top: 10px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }
    .tab-btn {
      padding: 10px 15px;
      border: none;
      border-bottom: 2px solid transparent;
      background: #f0f0f0;
      cursor: pointer;
      font-weight: bold;
    }
    .tab-btn.active {
      border-bottom: 2px solid #4caf50;
      background: #fff;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      padding: 15px;
    }
    .card {
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
    }
    .card.pending {
      border-color: #ffa500;
    }
    .card.confirmed {
      border-color: #4caf50;
    }
    .card h2 {
      margin: 0;
      font-size: 1.2em;
    }
    .card p, .card label {
      margin: 5px 0;
      display: block;
    }
    .actions {
      margin-top: 10px;
      display: flex;
      gap: 5px;
    }
    .btn {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
    }
    .accept-btn {
      background-color: #4caf50;
    }
    .reject-btn {
      background-color: #f44336;
    }
    .cancel-btn {
      background-color: #b71c1c;
    }
    .block-all-btn {
      background-color: #3f51b5;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .block-all-btn:hover {
      background-color: #303f9f;
    }
    img.room-photo {
      width: 100%;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    input[type="number"], input[type="file"] {
      width: 100%;
      padding: 5px;
      margin: 3px 0 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* small helper for embedded calendar controls */
    .calendar-inline-controls{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      margin: 10px 0 20px 0;
    }
    .calendar-inline-controls .button-icon{
      background:transparent;
      border:1px solid rgba(15,23,42,0.08);
      height:36px;
      min-width:36px;
      padding:6px;
      border-radius:8px;
      cursor:pointer;
    }
    #calendar-wrapper {
      width:100%;
      box-sizing:border-box;
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 8px rgba(0,0,0,0.04);
      margin-top:10px;
    }

    /* Room card layout: column so actions can be pushed to the bottom */
    #manage-rooms-tab .room-card {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 220px; /* make room for content and bottom button */
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    /* inner content grows, actions stay at bottom */
    #manage-rooms-tab .room-card .card-body { flex: 1 1 auto; }
    #manage-rooms-tab .room-card .room-actions { margin-top: auto; text-align: right; }

    /* description field */
    #manage-rooms-tab textarea[name="description"]{
      width:100%;
      box-sizing:border-box;
      min-height:80px;
      border:1px solid #ccc;
      border-radius:4px;
      padding:8px;
      resize:vertical;
      font-family:inherit;
    }
    #manage-rooms-tab label.room-desc { display:block; font-size:0.95rem; color:#333; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('reservations')">üìã Rezervace</button>
    <button class="tab-btn" onclick="showTab('manage-rooms')">üõ†Ô∏è Spr√°va pokoj≈Ø</button>
    <button class="tab-btn" onclick="showTab('seasons')">üìÖ Sez√≥ny</button>
  </div>

  <!-- Blokovat celou chatu button -->
  <div style="margin-bottom: 15px; text-align: center;">
    <button class="btn block-all-btn" onclick="showBlockForm()">üèïÔ∏è Blokovat celou chatu</button>
  </div>

  <!-- Hidden form for blocking all -->
  <div id="block-form" style="display:none; text-align: center; margin: 10px;">
    <h3>Blokovat term√≠n</h3>
    <label>Od: <input type="date" id="block-start"></label>
    <label>Do: <input type="date" id="block-end"></label>

    <div style="margin-top:12px; max-width:900px; margin-left:auto; margin-right:auto; text-align:left;">
      <label style="display:block; margin-bottom:8px;">
        <input type="checkbox" id="block-all-rooms"> Cel√° chata (za≈°krtnut√≠m oznaƒç√≠te v≈°echny pokoje a spoleƒçn√© prostory)
      </label>

      <strong>Vybrat pokoje</strong>
      <div id="block-rooms-list" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:6px; margin:8px 0;"></div>

      <strong>Spoleƒçn√© prostory</strong>
      <div id="block-common-list" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:6px; margin:8px 0;"></div>
    </div>

    <div style="margin-top:12px;">
      <button class="btn accept-btn" onclick="submitBlock()">Potvrdit</button>
      <button class="btn reject-btn" onclick="hideBlockForm()">Zru≈°it</button>
    </div>
  </div>

  <script>
    // block form helpers
    let _blockRoomsCache = [];
    let _blockCommonCache = [];

    async function loadBlockOptions() {
      try {
        const [roomsRes, commonRes] = await Promise.all([
          fetch('/api/rooms'),
          fetch('/api/common-rooms')
        ]);
        const rooms = await roomsRes.json();
        const common = await commonRes.json();
        _blockRoomsCache = rooms;
        _blockCommonCache = common;
        renderBlockOptions();
      } catch (e) {
        console.error('loadBlockOptions error', e);
      }
    }

    function renderBlockOptions() {
      const roomsList = document.getElementById('block-rooms-list');
      const commonList = document.getElementById('block-common-list');
      roomsList.innerHTML = '';
      commonList.innerHTML = '';

      _blockRoomsCache.forEach(r => {
        const id = `block-room-${r.id}`;
        const el = document.createElement('label');
        el.style.display = 'block';
        el.innerHTML = `<input type="checkbox" id="${id}" value="${r.id}"> ${r.name} (${r.beds} l≈Ø≈æek)`;
        roomsList.appendChild(el);
      });

      _blockCommonCache.forEach(r => {
        const id = `block-common-${r.id}`;
        const el = document.createElement('label');
        el.style.display = 'block';
        el.innerHTML = `<input type="checkbox" id="${id}" value="${r.id}"> ${r.name} (kapacita ${r.capacity})`;
        commonList.appendChild(el);
      });

      // master toggle
      const master = document.getElementById('block-all-rooms');
      master.checked = false;
      master.onchange = function() {
        const allBoxes = [...document.querySelectorAll('#block-rooms-list input[type=checkbox]'), ...document.querySelectorAll('#block-common-list input[type=checkbox]')];
        allBoxes.forEach(cb => cb.checked = master.checked);
      };
    }

    function showBlockForm() {
      document.getElementById('block-form').style.display = 'block';
      loadBlockOptions();
    }

    function hideBlockForm() {
      document.getElementById('block-form').style.display = 'none';
    }

    async function submitBlock() {
      const start = document.getElementById('block-start').value;
      const end = document.getElementById('block-end').value;
      if (!start || !end) { alert('Vyberte platn√© datum od-do.'); return; }

      // collect selected room ids
      const selectedRooms = Array.from(document.querySelectorAll('#block-rooms-list input[type=checkbox]:checked')).map(i => Number(i.value));
      const selectedCommon = Array.from(document.querySelectorAll('#block-common-list input[type=checkbox]:checked')).map(i => Number(i.value));

      if (!selectedRooms.length && !selectedCommon.length) {
        if (!confirm('Neoznaƒçili jste ≈æ√°dn√© pokoje ani spoleƒçn√© prostory. Chcete blokovat celou chatu?')) {
          return;
        }
      }

      if (!confirm(`Opravdu chcete blokovat od ${start} do ${end}?`)) return;

      const payload = { start, end };
      if (selectedRooms.length) payload.rooms = selectedRooms;
      if (selectedCommon.length) payload.commonRooms = selectedCommon;

      const res = await fetch('/api/block-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert('Blokace byla provedena.');
        hideBlockForm();
        renderAllBookings();
      } else {
        const err = await res.json().catch(() => ({}));
        alert(err.message || 'Chyba p≈ôi blokov√°n√≠.');
      }
    }
  </script>

  <!-- Reservations tab: contains both rooms and common rooms sections + embedded calendar -->
  <div id="reservations-tab" style="display:grid; gap:12px; padding:0 15px 15px 15px;">
    <h2 style="margin:8px 0;">Pokoje</h2>
    <div id="rooms-tab" class="container"></div>

    <h2 style="margin:12px 0 8px 0;">Spoleƒçn√© prostory</h2>
    <div id="common-tab" class="container"></div>

    <!-- Embedded calendar inside Rezervace -->
    <h2 style="margin:18px 0 8px 0;">Kalend√°≈ô dostupnosti</h2>
    <div id="calendar-wrapper" aria-label="Kalend√°≈ô dostupnosti">
      <!-- simple header controls -->
      <div class="calendar-inline-controls">
        <button id="prev-month" class="button-icon" title="P≈ôedchoz√≠ mƒõs√≠c">&lt;</button>
        <div id="current-month" style="font-weight:700;"></div>
        <button id="next-month" class="button-icon" title="Dal≈°√≠ mƒõs√≠c">&gt;</button>
      </div>

      <!-- half-day (morning/afternoon) calendar container -->
      <div id="calendar-container">
        <div id="half-calendar-container"></div>
      </div>
      <div id="selected-dates" style="margin-top:8px; text-align:center; color:#333;"></div>
    </div>
  </div>

  <!-- Manage Rooms Section -->
  <div id="manage-rooms-tab" class="container" style="display:none; gap:12px; padding:12px;">
    <!-- rooms-list will be populated by existing admin scripts; this container styling ensures cards behave -->
    <div id="rooms-list" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:12px;"></div>
  </div>

  <!-- Seasons Section -->
  <div id="seasons-tab" class="container" style="display:none; flex-direction:column; align-items:center;">
    <button class="btn block-all-btn" onclick="showSeasonForm()">P≈ôidat novou sez√≥nu</button>
    <div id="season-list"></div>
  </div>

  <h2 id="current-clients" style="text-align:center; color:#2196F3; margin-top:0;"></h2>

  <!-- Modal for adding season -->
  <div id="season-form-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center;">
    <form id="season-form" style="background:#fff; padding:20px; border-radius:8px; min-width:300px;">
      <h3>P≈ôidat sez√≥nu</h3>
      <label>N√°zev: <input type="text" id="season-name" required></label>
      <label>Od: <input type="date" id="season-start" required></label>
      <label>Do: <input type="date" id="season-end" required></label>
      <label>Typ √∫pravy:
        <select id="season-type">
          <option value="percent">Procentu√°ln√≠ zmƒõna (%)</option>
          <option value="flat">Pevn√° ƒç√°stka (Kƒç)</option>
        </select>
      </label>
      <label>Hodnota: <input type="number" id="season-value" required></label>
      <button type="submit" class="btn accept-btn">P≈ôidat</button>
      <button type="button" class="btn reject-btn" onclick="hideSeasonForm()">Zru≈°it</button>
    </form>
  </div>

  <script>
    let PENDING_TIMEOUT_MINUTES = 300; // fallback

    async function fetchConfig() {
      const res = await fetch('/api/config');
      if (res.ok) {
        const data = await res.json();
        PENDING_TIMEOUT_MINUTES = data.pendingTimeoutMinutes || 1;
      }
    }

    function showTab(tab) {
      // reservations is a wrapper that contains rooms and common sections
      document.getElementById('reservations-tab').style.display = (tab === 'reservations') ? 'grid' : 'none';
      document.getElementById('manage-rooms-tab').style.display = (tab === 'manage-rooms') ? 'grid' : 'none';
      document.getElementById('seasons-tab').style.display = (tab === 'seasons') ? 'flex' : 'none';
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      const selector = `.tab-btn[onclick="showTab('${tab}')"]`;
      const btn = document.querySelector(selector);
      if (btn) btn.classList.add('active');
    }

    async function fetchBookings(endpointPending, endpointConfirmed) {
      const pending = await fetch(endpointPending).then(res => res.json());
      const confirmed = await fetch(endpointConfirmed).then(res => res.json());
      return { pending, confirmed };
    }

    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('cs-CZ');
    }

    function createCard(booking, type, isCommon = false) {
      const card = document.createElement('div');
      card.className = 'card ' + type;

      const roomInfo = isCommon
        ? booking.rooms.map(id => getCommonRoomName(id)).join(", ")
        : booking.rooms.map(id => getRoomName(id)).join(", ");

      // Occupancy HTML (only for regular room bookings)
      let occupancyHtml = '';
      if (!isCommon && booking.occupancy && typeof booking.occupancy === 'object' && Object.keys(booking.occupancy).length) {
        const occItems = Object.keys(booking.occupancy).map(rid => {
          const name = getRoomName(rid);
          const cnt = booking.occupancy[rid];
          return `<li>${name}: ${cnt} osob</li>`;
        }).join('');
        occupancyHtml = `<p><strong>Obsazen√≠ po pokoj√≠ch:</strong><ul>${occItems}</ul></p>`;
      }

      card.innerHTML = `
        <h2>${booking.name}</h2>
        <p><strong>Od:</strong> ${formatDateTime(booking.start || booking.startDate)}</p>
        <p><strong>Do:</strong> ${formatDateTime(booking.end || booking.endDate)}</p>
        <p><strong>${isCommon ? "M√≠stnost" : "Pokoje"}:</strong> ${roomInfo}</p>
        <p><strong>Osoby:</strong> ${booking.people}</p>
        ${occupancyHtml}
        ${!isCommon ? (() => {
          let services = [];
          if (Array.isArray(booking.dogs) && booking.dogs.length) {
            services.push('Pes: ' + booking.dogs.map(id => getRoomName(id)).join(', '));
          }
          if (Array.isArray(booking.extraBeds) && booking.extraBeds.length) {
            services.push('P≈ôist√Ωlka: ' + booking.extraBeds.map(id => getRoomName(id)).join(', '));
          }
          if (booking.breakfast && booking.breakfastPeople) {
            services.push(`Sn√≠danƒõ pro ${booking.breakfastPeople} osob`);
          }
          return services.length ? `<p><strong>Slu≈æby:</strong> ${services.join('; ')}</p>` : '';
        })() : ""}
        <p><strong>Cena celkem:</strong> ${booking.totalPrice ? booking.totalPrice + ' Kƒç' : 'N/A'}</p>
        <p><strong>Email:</strong> ${booking.email}</p>
        <p><strong>Telefon:</strong> ${booking.phone}</p>
      `;

      // actions container
      const actions = document.createElement('div');
      actions.className = 'actions';

      if (type === 'pending') {
        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'btn accept-btn';
        acceptBtn.textContent = 'Potvrdit';
        acceptBtn.onclick = () => handleAction(booking.id, 'accept', isCommon);

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn reject-btn';
        rejectBtn.textContent = 'Zam√≠tnout';
        rejectBtn.onclick = () => handleAction(booking.id, 'reject', isCommon);

        actions.appendChild(acceptBtn);
        actions.appendChild(rejectBtn);
      } else if (type === 'confirmed') {
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn cancel-btn';
        cancelBtn.textContent = 'Zru≈°it';
        cancelBtn.onclick = () => handleCancel(booking.id, isCommon);
        actions.appendChild(cancelBtn);
      }

      // NEW: Receipt button (√öƒçet) - always available
      const receiptBtn = document.createElement('button');
      receiptBtn.className = 'btn';
      receiptBtn.style.background = '#1976d2';
      receiptBtn.style.border = 'none';
      receiptBtn.textContent = '√öƒçet';
      receiptBtn.onclick = () => showReceipt(booking, isCommon);
      actions.appendChild(receiptBtn);

      card.appendChild(actions);

      if (type === 'pending' && booking.createdAt) {
        const timer = document.createElement('div');
        timer.style.color = '#b71c1c';
        timer.style.fontWeight = 'bold';
        timer.style.marginBottom = '5px';
        card.prepend(timer);

        const timeoutMs = PENDING_TIMEOUT_MINUTES * 60 * 1000;
        const createdAt = new Date(booking.createdAt);
        const expiresAt = new Date(createdAt.getTime() + timeoutMs);

        function updateTimer() {
          const now = new Date();
          const diff = expiresAt - now;
          if (diff > 0) {
            const min = Math.floor(diff / 60000);
            const sec = Math.floor((diff % 60000) / 1000);
            timer.textContent = `Vypr≈°√≠ za: ${min}:${sec.toString().padStart(2, '0')}`;
          } else {
            timer.textContent = 'Rezervace vypr≈°ela';
          }
        }
        updateTimer();
        const interval = setInterval(() => {
          updateTimer();
          if (new Date() >= expiresAt) clearInterval(interval);
        }, 1000);
      }

      return card;
    }

    async function handleAction(id, action, isCommon) {
      const endpoint = isCommon
        ? `/api/common-bookings/${id}/${action}`
        : `/api/bookings/${id}/${action}`;
      const response = await fetch(endpoint, { method: 'POST' });
      if (response.ok) {
        alert(`Rezervace byla ${action === 'accept' ? 'potvrzena' : 'zam√≠tnuta'}.`);
        renderAllBookings();
      } else {
        const error = await response.json();
        alert(error.message || 'Chyba p≈ôi zpracov√°n√≠.');
      }
    }

    async function handleCancel(id, isCommon) {
      if (!confirm('Opravdu chcete zru≈°it tuto rezervaci? Tato akce je nevratn√°.')) {
        return;
      }
      const endpoint = isCommon
        ? `/api/common-bookings/${id}/cancel`
        : `/api/bookings/${id}/cancel`;
      const response = await fetch(endpoint, { method: 'DELETE' });
      if (response.ok) {
        alert('Rezervace byla zru≈°ena.');
        renderAllBookings();
      } else {
        const error = await response.json();
        alert(error.message || 'Chyba p≈ôi ru≈°en√≠ rezervace.');
      }
    }

    async function renderBookings(containerId, pendingEndpoint, confirmedEndpoint, isCommon = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = ''; // Clear container
      const { pending, confirmed } = await fetchBookings(pendingEndpoint, confirmedEndpoint);
      pending.forEach(b => container.appendChild(createCard(b, 'pending', isCommon)));
      confirmed.forEach(b => container.appendChild(createCard(b, 'confirmed', isCommon)));
    }

    // NOTE: showBlockForm / hideBlockForm / submitBlock are implemented earlier (they load block options)
    // Removed duplicate definitions so loadBlockOptions() / renderBlockOptions() are used and checkboxes render.

    async function renderAllBookings() {
      await renderBookings('rooms-tab', '/api/bookings/pending', '/api/bookings/confirmed');
      await renderBookings('common-tab', '/api/common-bookings/pending', '/api/common-bookings/confirmed', true);
      await renderRoomManagement();
      await updateCurrentClients();
    }

    async function renderRoomManagement() {
      const container = document.getElementById('rooms-list'); // place cards inside the grid container
      container.innerHTML = '';
      const rooms = await fetch('/api/rooms').then(res => res.json());

      rooms.forEach(room => {
        const card = document.createElement('div');
        card.className = 'card confirmed room-card';

        // card body
        const body = document.createElement('div');
        body.className = 'card-body';

        const title = document.createElement('h2');
        title.textContent = room.name;
        body.appendChild(title);

        if (room.photo) {
          const img = document.createElement('img');
          img.className = 'room-photo';
          img.src = `/images/rooms/${room.photo}`;
          img.alt = room.name;
          body.appendChild(img);
        }

        const priceLabel = document.createElement('label');
        priceLabel.textContent = 'Cena za noc (CZK): ';
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.value = room.price || '';
        priceInput.id = `price-${room.id}`;
        priceLabel.appendChild(priceInput);
        body.appendChild(priceLabel);

        const bedsLabel = document.createElement('label');
        bedsLabel.textContent = 'Poƒçet l≈Ø≈æek: ';
        const bedsInput = document.createElement('input');
        bedsInput.type = 'number';
        bedsInput.value = room.beds || '';
        bedsInput.id = `beds-${room.id}`;
        bedsLabel.appendChild(bedsInput);
        body.appendChild(bedsLabel);

        const photoLabel = document.createElement('label');
        photoLabel.textContent = 'Zmƒõnit foto: ';
        const photoInput = document.createElement('input');
        photoInput.type = 'file';
        photoInput.id = `photo-${room.id}`;
        photoInput.accept = 'image/*';
        photoInput.multiple = true;
        photoLabel.appendChild(photoInput);
        body.appendChild(photoLabel);

        if (room.photos && room.photos.length) {
          const thumbs = document.createElement('div');
          room.photos.forEach(p => {
            const t = document.createElement('img');
            t.src = `/images/rooms/${p}`;
            t.alt = room.name;
            t.style.width = '60px';
            t.style.height = '40px';
            t.style.margin = '2px';
            t.style.borderRadius = '3px';
            thumbs.appendChild(t);
          });
          body.appendChild(thumbs);
        }

        // description field (Popis)
        const descLabel = document.createElement('label');
        descLabel.className = 'room-desc';
        descLabel.innerHTML = 'Popis<br>';
        const descTextarea = document.createElement('textarea');
        descTextarea.name = 'description';
        descTextarea.id = `description-${room.id}`;
        descTextarea.placeholder = 'Popis pokoje';
        descTextarea.value = room.description || '';
        descLabel.appendChild(descTextarea);
        body.appendChild(descLabel);

        // extras (dog / extra bed) inside body so they remain above actions
        const extras = document.createElement('div');
        extras.innerHTML = `
          <div>
            <label>
              <input type="checkbox" id="dog-allowed-${room.id}" ${room.dogAllowed ? 'checked' : ''}>
              Pes povolen
            </label>
            <input type="number" id="dog-fee-${room.id}" value="${room.dogFee || 0}" min="0" style="width:80px;" placeholder="Cena za psa"> Kƒç
          </div>
          <div>
            <label>
              <input type="checkbox" id="extra-bed-allowed-${room.id}" ${room.extraBedAllowed ? 'checked' : ''}>
              P≈ôist√Ωlka povolena
            </label>
            <input type="number" id="extra-bed-fee-${room.id}" value="${room.extraBedFee || 0}" min="0" style="width:80px;" placeholder="Cena za p≈ôist√Ωlku"> Kƒç
          </div>
        `;
        body.appendChild(extras);

        card.appendChild(body);

        // actions container at the very bottom
        const actions = document.createElement('div');
        actions.className = 'room-actions';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn accept-btn';
        saveBtn.type = 'button';
        saveBtn.innerHTML = 'üíæ Ulo≈æit zmƒõny';
        saveBtn.onclick = () => saveRoom(room.id);
        actions.appendChild(saveBtn);
        card.appendChild(actions);

        container.appendChild(card);
      });
    }

    async function saveRoom(roomId) {
      const price = document.getElementById(`price-${roomId}`).value;
      const beds = document.getElementById(`beds-${roomId}`).value;
      const photoInput = document.getElementById(`photo-${roomId}`);
      const photoFiles = photoInput ? photoInput.files : [];
      const dogAllowed = document.getElementById(`dog-allowed-${roomId}`)?.checked || false;
      const dogFee = parseInt(document.getElementById(`dog-fee-${roomId}`)?.value || 0, 10) || 0;
      const extraBedAllowed = document.getElementById(`extra-bed-allowed-${roomId}`)?.checked || false;
      const extraBedFee = parseInt(document.getElementById(`extra-bed-fee-${roomId}`)?.value || 0, 10) || 0;
      const description = document.getElementById(`description-${roomId}`)?.value || '';

      const formData = new FormData();
      formData.append('id', roomId);
      formData.append('price', price);
      formData.append('beds', beds);
      formData.append('dogAllowed', dogAllowed);
      formData.append('dogFee', dogFee);
      formData.append('extraBedAllowed', extraBedAllowed);
      formData.append('extraBedFee', extraBedFee);
      formData.append('description', description);
      for (let i = 0; i < photoFiles.length; i++) {
        formData.append('photos', photoFiles[i]);
      }

      const res = await fetch('/api/rooms/update', {
        method: 'POST',
        body: formData
      });

      if (res.ok) {
        alert('Pokoj byl aktualizov√°n.');
        renderRoomManagement();
      } else {
        alert('Chyba p≈ôi ukl√°d√°n√≠ zmƒõn.');
      }
    }

    let commonRoomsList = [];
    let roomsList = []; // <-- store regular rooms for name lookup
    async function loadCommonRooms() {
      const res = await fetch('/api/common-rooms');
      commonRoomsList = await res.json();
    }
    async function loadRoomsAdmin() {
      const res = await fetch('/api/rooms');
      roomsList = await res.json();
    }
    function getRoomName(id) {
      const r = roomsList.find(room => room.id === Number(id));
      return r ? r.name : `Pokoj ${id}`;
    }
    function getCommonRoomName(id) {
      const room = commonRoomsList.find(r => r.id === id);
      return room ? room.name : "Nezn√°m√° m√≠stnost";
    }

    async function showReceipt(booking, isCommon) {
  // fetch seasons so we can compute season-adjusted nightly prices per room
  let seasonsData = [];
  try {
    const sres = await fetch('/api/seasons');
    if (sres.ok) seasonsData = await sres.json();
  } catch (e) { seasonsData = []; }

  const getRoom = id => roomsList.find(r => String(r.id) === String(id)) || { name: `Pokoj ${id}`, price: 0, dogFee: 0, extraBedFee: 0 };
  const getCommon = id => commonRoomsList.find(r => r.id === Number(id)) || { name: `Spoleƒçn√° ${id}`, capacity: 0 };

  const start = new Date(booking.start || booking.startDate);
  const end = new Date(booking.end || booking.endDate);
  start.setHours(0,0,0,0);
  end.setHours(0,0,0,0);
  const nights = Math.max(0, Math.round((end - start) / (1000*60*60*24)));

  // helper: compute room total with season adjustments (same logic as booking-wizard)
  function computeRoomPriceWithSeasons(room, startDate, endDate, seasons) {
    const nightsCount = Math.max(0, Math.round((endDate - startDate) / (1000*60*60*24)));
    let total = 0;
    for (let i = 0; i < nightsCount; i++) {
      const day = new Date(startDate);
      day.setDate(day.getDate() + i);
      day.setHours(0,0,0,0);
      let percent = 0, flat = 0;
      seasons.forEach(season => {
        const s = new Date(season.start);
        const e = new Date(season.end);
        s.setHours(0,0,0,0); e.setHours(0,0,0,0);
        if (day >= s && day < e) {
          if (season.type === 'percent') percent += Number(season.value || 0);
          else if (season.type === 'flat') flat += Number(season.value || 0);
        }
      });
      const base = Number(room.price || 0);
      const nightPrice = base * (1 + percent / 100) + flat;
      total += nightPrice;
    }
    return Math.round(total);
  }

  let lines = [];
  let subtotal = 0;

  (booking.rooms || []).forEach(rid => {
    if (isCommon) {
      const cm = getCommon(rid);
      const label = `${cm.name} (spoleƒçn√° m√≠stnost) x ${nights} noc√≠`;
      const amount = 0;
      lines.push({ label, amount });
      subtotal += amount;
    } else {
      const room = getRoom(rid);
      const roomTotal = computeRoomPriceWithSeasons(room, start, end, seasonsData);
      lines.push({ label: `${room.name} - pokoj x ${nights} noc√≠`, amount: roomTotal });
      subtotal += roomTotal;

      if (Array.isArray(booking.dogs) && booking.dogs.map(String).includes(String(rid))) {
        const dogFee = Number(room.dogFee || 0);
        lines.push({ label: `${room.name} - pes (poplatek)`, amount: dogFee });
        subtotal += dogFee;
      }

      if (Array.isArray(booking.extraBeds) && booking.extraBeds.map(String).includes(String(rid))) {
        const ebFee = Number(room.extraBedFee || 0);
        const ebTotal = ebFee * nights;
        lines.push({ label: `${room.name} - p≈ôist√Ωlka (${ebFee} Kƒç / noc) x ${nights}`, amount: ebTotal });
        subtotal += ebTotal;
      }
    }
  });

  if (booking.breakfast || booking.breakfastPeople) {
    const peopleForBreakfast = Number(booking.breakfastPeople || booking.people || 0);
    const breakfastPer = 150;
    const breakfastTotal = peopleForBreakfast * breakfastPer * nights;
    lines.push({ label: `Sn√≠danƒõ (${peopleForBreakfast} osob x ${breakfastPer} Kƒç / os. / noc) x ${nights}`, amount: breakfastTotal });
    subtotal += breakfastTotal;
  }

  const serverTotal = booking.totalPrice != null ? Number(booking.totalPrice) : null;
  const total = serverTotal !== null ? serverTotal : subtotal;

  const fullHtml = `
    <!doctype html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>√öƒçet - rezervace ${booking.name || booking.id}</title>
      <style>
        body { font-family: Arial, sans-serif; padding:20px; color:#111; }
        h1 { font-size:18px; margin-bottom:6px; }
        .meta { margin-bottom:12px; }
        table { width:100%; border-collapse:collapse; margin-top:8px; }
        th, td { padding:8px 6px; border-bottom:1px solid #eee; text-align:left; }
        th { background:#fafafa; }
        .amount { text-align:right; white-space:nowrap; }
        .total-row td { font-weight:700; border-top:2px solid #222; }
        .note { margin-top:12px; font-size:0.95rem; color:#444; }
        @media print { .no-print { display:none; } }
      </style>
    </head>
    <body>
      <h1>√öƒçet za rezervaci</h1>
      <div class="meta">
        <div><strong>Jm√©no:</strong> ${booking.name || '-'}</div>
        <div><strong>Datum:</strong> ${booking.start || booking.startDate} ‚Äì ${booking.end || booking.endDate}</div>
        <div><strong>Poƒçet noc√≠:</strong> ${nights}</div>
        <div><strong>Poƒçet osob:</strong> ${booking.people || '-'}</div>
      </div>

      <table>
        <thead>
          <tr><th>Polo≈æka</th><th class="amount">Cena (Kƒç)</th></tr>
        </thead>
        <tbody>
          ${lines.map(l => `<tr><td>${l.label}</td><td class="amount">${Math.round(l.amount)}</td></tr>`).join('')}
          <tr class="total-row"><td>Celkem</td><td class="amount">${Math.round(total)}</td></tr>
        </tbody>
      </table>

      ${serverTotal !== null ? `<div class="note">Pozn√°mka: Celkov√° cena nahl√°≈°en√° serverem: ${serverTotal} Kƒç. Pokud se li≈°√≠, zkontrolujte slevy nebo sez√≥nn√≠ √∫pravy.</div>` : ''}
      <div style="margin-top:18px;">
        <button onclick="window.print()" class="no-print" style="padding:8px 12px; background:#1976d2; color:#fff; border:none; border-radius:4px; cursor:pointer;">Tisk</button>
        <button onclick="window.close()" class="no-print" style="padding:8px 12px; margin-left:8px; background:#f0f0f0; border:none; border-radius:4px; cursor:pointer;">Zav≈ô√≠t</button>
      </div>
    </body>
    </html>
  `;

  // Try to open a new tab/window first
  let w;
  try {
    w = window.open('', '_blank');
    if (w) {
      try { w.opener = null; } catch (e) {}
      w.document.open();
      w.document.write(fullHtml);
      w.document.close();
      w.focus && w.focus();
      return;
    }
  } catch (e) {
    w = null;
  }

  // Fallback: create an in-page modal with an iframe and write the receipt into it
  const modalId = 'receipt-modal';
  const existing = document.getElementById(modalId);
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = modalId;
  Object.assign(modal.style, {
    position: 'fixed', left: 0, top: 0, right: 0, bottom: 0,
    background: 'rgba(0,0,0,0.6)', zIndex: 99999, display: 'flex',
    alignItems: 'center', justifyContent: 'center', padding: '20px'
  });

  const frameWrap = document.createElement('div');
  Object.assign(frameWrap.style, { width: '100%', maxWidth: '900px', height: '80vh', background: '#fff', borderRadius: '6px', overflow: 'hidden', display:'flex', flexDirection:'column' });

  const toolbar = document.createElement('div');
  Object.assign(toolbar.style, { padding: '8px', background:'#fafafa', borderBottom: '1px solid #eee', display:'flex', gap:'8px', justifyContent:'flex-end' });

  const printBtn = document.createElement('button');
  printBtn.textContent = 'Tisk';
  Object.assign(printBtn.style, { padding:'6px 10px', background:'#1976d2', color:'#fff', border:'none', borderRadius:'4px', cursor:'pointer' });
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Zav≈ô√≠t';
  Object.assign(closeBtn.style, { padding:'6px 10px', background:'#f0f0f0', border:'none', borderRadius:'4px', cursor:'pointer' });

  toolbar.appendChild(printBtn);
  toolbar.appendChild(closeBtn);

  const iframe = document.createElement('iframe');
  iframe.style.border = '0';
  iframe.style.flex = '1 1 auto';
  iframe.style.width = '100%';
  iframe.style.height = '100%';

  frameWrap.appendChild(toolbar);
  frameWrap.appendChild(iframe);
  modal.appendChild(frameWrap);
  document.body.appendChild(modal);

  try {
    const idoc = iframe.contentWindow.document;
    idoc.open();
    idoc.write(fullHtml);
    idoc.close();
  } catch (e) {
    const fallback = document.createElement('div');
    fallback.style.padding = '20px';
    fallback.innerText = 'Nelze zobrazit n√°hled √∫ƒçtu v r√°mci str√°nky.';
    frameWrap.appendChild(fallback);
  }

  printBtn.onclick = function() {
    try { iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch (e) { window.print(); }
  };
  closeBtn.onclick = function() { modal.remove(); };
}

    async function updateCurrentClients() {
      const res = await fetch('/api/bookings/confirmed');
      const bookings = await res.json();
      const today = new Date();
      let count = 0;
      bookings.forEach(b => {
        if (
          b.startDate &&
          b.endDate &&
          new Date(b.startDate) <= today &&
          new Date(b.endDate) > today
        ) {
          count += b.people || 0;
        }
      });
      document.getElementById('current-clients').textContent =
        `Aktu√°lnƒõ ubytovan√Ωch klient≈Ø: ${count}`;
    }

    // Initialize
    fetchConfig().then(() => {
      // load both common rooms and regular rooms first so createCard can show room names for occupancy
      Promise.all([loadCommonRooms(), loadRoomsAdmin()]).then(() => renderAllBookings());
    });

    // Season management
    document.getElementById('season-form').onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById('season-name').value;
      const start = document.getElementById('season-start').value;
      const end = document.getElementById('season-end').value;
      const type = document.getElementById('season-type').value;
      const value = document.getElementById('season-value').value;

      const payload = { name, start, end, type, value };

      const res = await fetch('/api/seasons', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert('Sez√≥na byla p≈ôid√°na.');
        hideSeasonForm();
        renderSeasonList && renderSeasonList();
      } else {
        const error = await res.json();
        alert(error.message || 'Chyba p≈ôi p≈ôid√°v√°n√≠ sez√≥ny.');
      }
    };

    function showSeasonForm() {
      document.getElementById('season-form-modal').style.display = 'flex';
    }
    function hideSeasonForm() {
      document.getElementById('season-form-modal').style.display = 'none';
      document.getElementById('season-form').reset();
    }

    async function renderSeasons() {
      const res = await fetch('/api/seasons');
      const seasons = await res.json();
      const list = document.getElementById('season-list');
      list.innerHTML = '';
      if (seasons.length === 0) {
        list.innerHTML = '<p>≈Ω√°dn√© sez√≥ny.</p>';
        return;
      }
      seasons.forEach(season => {
        const div = document.createElement('div');
        div.style = "border:1px solid #ccc; border-radius:6px; padding:8px; margin:8px 0; background:#fafafa;";
        div.innerHTML = `
          <strong>${season.name}</strong> (${season.start} ‚Äì ${season.end})<br>
          ${season.type === 'percent' ? (season.value > 0 ? '+' : '') + season.value + '%' : (season.value > 0 ? '+' : '') + season.value + ' Kƒç'}
          <button class="btn reject-btn" style="margin-left:10px;" onclick="deleteSeason(${season.id})">Smazat</button>
        `;
        list.appendChild(div);
      });
    }

    document.getElementById('season-form').onsubmit = async function(e) {
      e.preventDefault();
      const payload = {
        name: document.getElementById('season-name').value,
        start: document.getElementById('season-start').value,
        end: document.getElementById('season-end').value,
        type: document.getElementById('season-type').value,
        value: parseFloat(document.getElementById('season-value').value)
      };
      const res = await fetch('/api/seasons', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        hideSeasonForm();
        renderSeasons();
      }
    };

    async function deleteSeason(id) {
      if (!confirm('Opravdu smazat tuto sez√≥nu?')) return;
      await fetch('/api/seasons/' + id, { method: 'DELETE' });
      renderSeasons();
    }

    // Call renderSeasons when tab is shown
    document.querySelector('.tab-btn[onclick="showTab(\'seasons\')"]').addEventListener('click', renderSeasons);

    // Enhance existing room cards: add "Popis" textarea if missing and ensure save button sits at bottom.
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('manage-rooms-tab') || document.body;

      function enhanceCard(card) {
        if (!card.classList.contains('room-card')) return;

        // wrap existing main inputs into .card-body if not present
        if (!card.querySelector('.card-body')) {
          const body = document.createElement('div');
          body.className = 'card-body';
          // move all non-action children into body
          const children = Array.from(card.childNodes);
          children.forEach(n => {
            if (n.nodeType === 1 && (n.classList && String(n.classList).match(/room-actions|room-actions/))) return;
            body.appendChild(n);
          });
          card.insertBefore(body, card.firstChild);
        }

        // Add description field if missing
        if (!card.querySelector('textarea[name="description"]')) {
          const descLabel = document.createElement('label');
          descLabel.className = 'room-desc';
          descLabel.innerHTML = 'Popis<br><textarea name="description" placeholder="Popis pokoje"></textarea>';
          // insert before actions if present, else at end of body
          const actions = card.querySelector('.room-actions, .actions, .card-actions');
          if (actions) actions.parentNode.insertBefore(descLabel, actions);
          else card.querySelector('.card-body').appendChild(descLabel);
        }

        // Normalize actions: ensure there is a container with class .room-actions so CSS can push it down
        let actions = card.querySelector('.room-actions');
        if (!actions) {
          // try to find last button and wrap it
          const lastBtn = card.querySelector('button:last-of-type');
          if (lastBtn) {
            actions = document.createElement('div');
            actions.className = 'room-actions';
            lastBtn.parentNode.insertBefore(actions, lastBtn);
            actions.appendChild(lastBtn);
          }
        }
      }

      function processAll() {
        document.querySelectorAll('#manage-rooms-tab .room-card').forEach(enhanceCard);
      }

      // initial run and keep watching for dynamically added cards
      processAll();
      const obs = new MutationObserver(() => processAll());
      obs.observe(container, { childList: true, subtree: true });
    });
  </script>

  <!-- load calendar behavior (uses #calendar, #calendar-body, #prev-month, #next-month, #current-month) -->
  <script src="/script.js"></script>

  <!-- initialize admin UI after calendar script is loaded -->
  <script>
    // Avoid calling fetchConfig() + renderAllBookings() again (that caused double rendering).
    // Only re-bind season render trigger which is safe to run after scripts load.
    document.querySelector('.tab-btn[onclick="showTab(\'seasons\')"]')?.addEventListener('click', renderSeasons);
  </script>
  
  <!-- iframe removed ‚Äî calendar is embedded directly in Rezervace tab -->
</body>
</html>
